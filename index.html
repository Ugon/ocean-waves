<html>
<head>
    <title>Ocean Waves</title>
    <meta http-equiv="content-type" content="text/html">
</head>
<body>
    <canvas id="canvas"></canvas>
</body>

<script type="text/javascript" src='lib/gl-matrix.js'></script>
<script type="text/javascript" src="camera.js"></script>
<script type="text/javascript" src="parameters.js"></script>
<script type="text/javascript" src="webgl-boilerplate.js"></script>

<script id="pass-position-vertex-shader" type="x-shader/x-vertex">
    precision highp float;
    
    attribute vec2 a_position;

    varying vec2 v_position;
    
    void main(void) {
        v_position = a_position;
        gl_Position = vec4(a_position, 0, 1);
    }
</script>

<script id="height-init-in-frequency-fragment-shader" type="x-shader/x-fragment">
    // #define PHILLIPS_CONST
    precision highp float;

    uniform sampler2D u_randomComplexNumbers;
    uniform vec2      u_windVector;
    uniform float     u_transformSize;
    uniform float     u_areaSize;

    float PI = 3.14159265359;
    float g  = 9.81;

    float square(float a){
        return a * a;
    }

    vec2 index2TexturePosition(vec2 ind){
        return ind / u_transformSize;
    }

    void main(void) {
        vec2 index_xy = gl_FragCoord.xy;                                          //[0, u_transformSize)
        vec2 nm       = index_xy - vec2(u_transformSize, u_transformSize) * 0.5;  //[-u_transformSize/2, u_transformSize/2)
        vec2 k        = 2.0 * nm * PI / u_areaSize;
        float klen = length(k);

        float V = length(u_windVector);
        float L = V * V / g;

        //Phillips spectrum
        float Ph = PHILLIPS_CONST
                 * exp((-1.0 / square(klen * L))) / square(klen * klen) 
                 * square(dot(normalize(k), normalize(u_windVector)))      //direction factor
                 * exp(-square(klen * u_areaSize / 1000.0));               //remove small waves
        float sqrtPh = sqrt(Ph * 0.5);

        vec2 randomComplexNumber = texture2D(u_randomComplexNumbers, index2TexturePosition(index_xy)).xy;
        vec2 h0 = randomComplexNumber * sqrtPh;

        gl_FragColor = vec4(h0, 0, 1);
    }
</script>

<script id="height-after-t-in-frequency-fragment-shader" type="x-shader/x-fragment">
    precision highp float;

    uniform sampler2D u_h0;
    uniform float     u_transformSize; 
    uniform float     u_areaSize;
    uniform float     u_t;

    float PI = 3.14159265359;
    float g  = 9.81;

    float omega(float klen){
        return sqrt(g * klen);
    }
    
    vec2 index2TexturePosition(vec2 ind){
        return ind / u_transformSize;
    }

    vec2 minusIndex(vec2 ind){
        return vec2(u_transformSize - 1.0, u_transformSize - 1.0) - ind;
    }

    void main(void) {
        vec2 index_xy = gl_FragCoord.xy;                                          //[0, u_transformSize)
        vec2 nm       = index_xy - vec2(u_transformSize, u_transformSize) * 0.5;  //[-u_transformSize/2, u_transformSize/2)
        vec2 k        = 2.0 * nm * PI / u_areaSize;

        vec2 h0k      = texture2D(u_h0, index2TexturePosition(           index_xy )).xy;
        vec2 h0minusk = texture2D(u_h0, index2TexturePosition(minusIndex(index_xy))).xy;
       
        float wt = omega(length(k)) * u_t;
        float coswt = cos(wt);
        float sinwt = sin(wt);

        vec2 hkt;
        hkt.x = h0k.x * coswt - h0k.y * sinwt + h0minusk.x * coswt - h0minusk.y * sinwt;
        hkt.y = h0k.x * sinwt + h0k.y * coswt - h0minusk.x * sinwt + h0minusk.y * coswt;

        gl_FragColor = vec4(hkt, k);
    }
</script>

<script id="displacement-after-t-in-frequency-fragment-shader" type="x-shader/x-fragment">
    precision highp float;

    uniform sampler2D u_height_k;
    uniform float     u_transformSize; 

    vec2 index2TexturePosition(vec2 ind){
        return ind / u_transformSize;
    }

    vec2 complexMultI(vec2 complex){
        return vec2(-complex.y, complex.x);
    }

    void main(void) {
        vec2 index_xy = gl_FragCoord.xy; //[0, u_transformSize)

        vec4 height_k = texture2D(u_height_k, index2TexturePosition( index_xy ));
        vec2 hkt      = height_k.xy;
        vec2 k        = height_k.zw;

        vec2 ihkt_x   = -complexMultI(hkt * k.x / length(k));
        vec2 ihkt_y   = -complexMultI(hkt * k.y / length(k));

        gl_FragColor  = vec4(ihkt_x, ihkt_y);
    }
</script>


<script id="fft-fragment-shader" type="x-shader/x-fragment">
    precision highp float;

    uniform sampler2D u_input;
    uniform float u_transformSize;
    uniform float u_subtransformSize;

    float PI = 3.14159265359;

    vec2 complexTryg(float alpha){
        return vec2(cos(alpha), sin(alpha));
    }

    vec2 index2TexturePosition(vec2 ind){
        return ind / u_transformSize;
    }

    void main(void) {
        float index_x = gl_FragCoord.x; //[0, u_transformSize)
        float index_y = gl_FragCoord.y; //[0, u_transformSize)

    #ifdef ROWS
        float base   = floor(index_x / u_subtransformSize) * u_subtransformSize * 0.5;
        float offset = mod(index_x, u_subtransformSize * 0.5);
    #endif

    #ifdef COLS
        float base   = floor(index_y / u_subtransformSize) * u_subtransformSize * 0.5;
        float offset = mod(index_y, u_subtransformSize * 0.5);
    #endif

        float index_0 = base + offset;
        float index_1 = index_0 + u_transformSize * 0.5;

    #ifdef ROWS
        vec2 twiddle       = complexTryg((-2.0) * PI * (index_x / u_subtransformSize));
        vec4 textureValue0 = texture2D(u_input, index2TexturePosition(vec2(index_0, index_y)));
        vec4 textureValue1 = texture2D(u_input, index2TexturePosition(vec2(index_1, index_y)));
    #endif

    #ifdef COLS
        vec2 twiddle       = complexTryg((-2.0) * PI * (index_y / u_subtransformSize));
        vec4 textureValue0 = texture2D(u_input, index2TexturePosition(vec2(index_x, index_0)));
        vec4 textureValue1 = texture2D(u_input, index2TexturePosition(vec2(index_x, index_1)));
    #endif

        vec2 val0_0   = textureValue0.xy;
        vec2 val1_0   = textureValue1.xy;
        vec2 result_0 = vec2(val0_0.x + twiddle.x * val1_0.x - twiddle.y * val1_0.y,
                             val0_0.y + twiddle.y * val1_0.x + twiddle.x * val1_0.y);

    #ifdef DOUBLE
        vec2 val0_1   = textureValue0.zw;
        vec2 val1_1   = textureValue1.zw;
        vec2 result_1 = vec2(val0_1.x + twiddle.x * val1_1.x - twiddle.y * val1_1.y,
                             val0_1.y + twiddle.y * val1_1.x + twiddle.x * val1_1.y);
    #endif

    #ifdef DOUBLE
        gl_FragColor = vec4(result_0, result_1);        
    #else   
        gl_FragColor = vec4(result_0, 0, 1);        
    #endif
    }
</script>

<script id="grid-vertex-shader" type="x-shader/x-vertex">
    // #define DISPLACEMENT_CONST 
    precision highp float;
    
    attribute vec2 a_position; //[-1, 1]

    varying vec3 v_position;

    uniform sampler2D u_height;
    uniform sampler2D u_displacement;
    
    uniform mat4 u_perspectiveMatrix;
    uniform mat4 u_viewMatrix;
    
    vec2 position2TexturePosition(vec2 pos){
        return pos * 0.5 + 0.5;
    }

    void main(void) {
        vec2 texPos = position2TexturePosition(a_position);

        float height         = length(texture2D(u_height, texPos).xy);
        float displacement_x = length(texture2D(u_displacement, texPos).xy);
        float displacement_y = length(texture2D(u_displacement, texPos).zw);
        vec2  displacement   = vec2(displacement_x, displacement_y);

        vec2 dispPos = a_position + displacement * DISPLACEMENT_CONST;
        vec3 position = vec3(dispPos.x, height, dispPos.y);

        v_position = position;
        v_position.z = height;
        gl_Position = u_perspectiveMatrix * u_viewMatrix * vec4(position, 1);
    }
</script>

<script id="grid-fragment-shader" type="x-shader/x-fragment">
    precision highp float;

    varying vec3 v_position;

    float position2TexturePosition(float pos){
        return pos * 0.5 + 0.5;
    }

    void main(void) {
        // gl_FragColor = vec4(0.9 * (v_position.zzz * 0.5 + 0.5), 1);
        gl_FragColor = vec4(0.9 * (v_position.zzz * 0.5 + 0.5), 1);
        // gl_FragColor = vec4(1, 0, 0, 1);
    }
</script>



<script>
    var canvas = document.getElementById('canvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;


    var gl = canvas.getContext('experimental-webgl');
    gl.getExtension('OES_texture_float');


    /*****************************************************************/
    /**************************BUILD SHADERS**************************/
    /*****************************************************************/
    var passPositionVertexShaderSource = document.getElementById('pass-position-vertex-shader').text;
    var passPositionVertexShader = buildVertexShader(gl, passPositionVertexShaderSource);

    var heightInitInFrequencyFragmentShaderSource = 
        '#define PHILLIPS_CONST {0}\n'.format(f2s(PHILLIPS_CONST)) +
        document.getElementById('height-init-in-frequency-fragment-shader').text;
    var heightInitInFrequencyFragmentShader = buildFragmentShader(gl, heightInitInFrequencyFragmentShaderSource);

    var heightAfterTInFrequencyFragmentShaderSource = document.getElementById('height-after-t-in-frequency-fragment-shader').text;
    var heightAfterTInFrequencyFragmentShader = buildFragmentShader(gl, heightAfterTInFrequencyFragmentShaderSource);

    var displacementAfterTInFrequencyFragmentShaderSource = document.getElementById('displacement-after-t-in-frequency-fragment-shader').text;
    var displacementAfterTInFrequencyFragmentShader = buildFragmentShader(gl, displacementAfterTInFrequencyFragmentShaderSource);

    var fft1RowsFragmentShaderSource = 
        '#define ROWS\n' + 
        document.getElementById('fft-fragment-shader').text;
    var fft1RowsFragmentShader = buildFragmentShader(gl, fft1RowsFragmentShaderSource);
    
    var fft1ColsFragmentShaderSource = 
        '#define COLS\n' + 
        document.getElementById('fft-fragment-shader').text;
    var fft1ColsFragmentShader = buildFragmentShader(gl, fft1ColsFragmentShaderSource);
 
    var fft2RowsFragmentShaderSource = 
        '#define ROWS\n' + 
        '#define DOUBLE\n' + 
        document.getElementById('fft-fragment-shader').text;
    var fft2RowsFragmentShader = buildFragmentShader(gl, fft2RowsFragmentShaderSource);
    
    var fft2ColsFragmentShaderSource = 
        '#define COLS\n' + 
        '#define DOUBLE\n' + 
        document.getElementById('fft-fragment-shader').text;
    var fft2ColsFragmentShader = buildFragmentShader(gl, fft2ColsFragmentShaderSource);

    var gridVertexShaderSource = 
        '#define DISPLACEMENT_CONST {0}\n'.format(f2s(DISPLACEMENT_CONST)) +
        document.getElementById('grid-vertex-shader').text;
    var gridVertexShader = buildVertexShader(gl, gridVertexShaderSource);

    var gridFragmentShaderSource = document.getElementById('grid-fragment-shader').text;
    var gridFragmentShader = buildFragmentShader(gl, gridFragmentShaderSource);

    /*****************************************************************/
    /*************************INIT TEXTURES***************************/
    /*****************************************************************/
    var randomNormalPairs = [];
    for (var i = 0; i < TRANSFORM_SIZE * TRANSFORM_SIZE; i++){
        randomNormalPairs.push(randomNormal());
        randomNormalPairs.push(randomNormal());
        randomNormalPairs.push(0);
        randomNormalPairs.push(0);
    }

    var randomComplexNumbersTexture          = buildDataTexture(gl, UNIT_TEXTURE_RANDOM_COMPLEX_NUMBERS, TRANSFORM_SIZE, TRANSFORM_SIZE, 
                                                                new Float32Array(randomNormalPairs));
    var initHeightInFrequencyTexture         = buildDataTexture(gl, UNIT_TEXTURE_INIT_HEIGHT_IN_FREQUENCY, TRANSFORM_SIZE, TRANSFORM_SIZE, null);
    var heightAfterTInFrequencyTexture       = buildDataTexture(gl, UNIT_TEXTURE_HEIGHT_AFTER_T_IN_FREQUENCY, TRANSFORM_SIZE, TRANSFORM_SIZE, null);
    var heightAfterTInTimeTexture            = buildDataTexture(gl, UNIT_TEXTURE_HEIGHT_AFTER_T_IN_TIME, TRANSFORM_SIZE, TRANSFORM_SIZE, null);
    var displacementAfterTInFrequencyTexture = buildDataTexture(gl, UNIT_TEXTURE_DISPLACEMENT_AFTER_T_IN_FREQUENCY, TRANSFORM_SIZE, TRANSFORM_SIZE, null);
    var displacementAfterTInTimeTexture      = buildDataTexture(gl, UNIT_TEXTURE_DISPLACEMENT_AFTER_T_IN_TIME, TRANSFORM_SIZE, TRANSFORM_SIZE, null);
    var pingTexture                          = buildDataTexture(gl, UNIT_TEXTURE_PING, TRANSFORM_SIZE, TRANSFORM_SIZE, null);
    var pongTexture                          = buildDataTexture(gl, UNIT_TEXTURE_PONG, TRANSFORM_SIZE, TRANSFORM_SIZE, null);



    /*****************************************************************/
    /***********************INIT FRAMEBUFFERS*************************/
    /*****************************************************************/
    var initHeightInFrequencyFramebuffer         = buildFramebuffer(gl, initHeightInFrequencyTexture);
    var heightAfterTInFrequencyFramebuffer       = buildFramebuffer(gl, heightAfterTInFrequencyTexture);
    var heightAfterTInTimeFramebuffer            = buildFramebuffer(gl, heightAfterTInTimeTexture);
    var displacementAfterTInFrequencyFramebuffer = buildFramebuffer(gl, displacementAfterTInFrequencyTexture);
    var displacementAfterTInTimeFramebuffer      = buildFramebuffer(gl, displacementAfterTInTimeTexture);
    var pingFramebuffer                          = buildFramebuffer(gl, pingTexture);
    var pongFramebuffer                          = buildFramebuffer(gl, pongTexture);


    var isPingCurrent = true;
    var changeCurrentPingPong = function() { isPingCurrent = !isPingCurrent; }
    var getCurrentPingPongTexture = function() { return isPingCurrent ? pingTexture : pongTexture; }
    var getCurrentPingPongFramebuffer = function() { return isPingCurrent ? pingFramebuffer : pongFramebuffer; }
    var getCurrentPingPongTextureUnit = function() { return isPingCurrent ? UNIT_TEXTURE_PING : UNIT_TEXTURE_PONG; }

    /*****************************************************************/
    /***********************BUILD PROGRAMS****************************/
    /*****************************************************************/
    var initHeightInFrequencyProgram = buildProgramData(gl, passPositionVertexShader, heightInitInFrequencyFragmentShader, 
        { 'a_position': INDEX_BUFFER_FULLSCREEN });
    gl.useProgram(initHeightInFrequencyProgram.program);
    gl.uniform1i(initHeightInFrequencyProgram.uniformLocations['u_randomComplexNumbers'], UNIT_TEXTURE_RANDOM_COMPLEX_NUMBERS);
    gl.uniform2f(initHeightInFrequencyProgram.uniformLocations['u_windVector'], WIND_X, WIND_Y);
    gl.uniform1f(initHeightInFrequencyProgram.uniformLocations['u_transformSize'], TRANSFORM_SIZE);
    gl.uniform1f(initHeightInFrequencyProgram.uniformLocations['u_areaSize'], AREA_SIZE);

    var heightAfterTInFrequencyProgram = buildProgramData(gl, passPositionVertexShader, heightAfterTInFrequencyFragmentShader, 
        { 'a_position': INDEX_BUFFER_FULLSCREEN });
    gl.useProgram(heightAfterTInFrequencyProgram.program);
    gl.uniform1i(heightAfterTInFrequencyProgram.uniformLocations['u_h0'], UNIT_TEXTURE_INIT_HEIGHT_IN_FREQUENCY);
    gl.uniform1f(heightAfterTInFrequencyProgram.uniformLocations['u_transformSize'], TRANSFORM_SIZE);
    gl.uniform1f(heightAfterTInFrequencyProgram.uniformLocations['u_areaSize'], AREA_SIZE);

    var displacementAfterTInFrequencyProgram = buildProgramData(gl, passPositionVertexShader, displacementAfterTInFrequencyFragmentShader, 
        { 'a_position': INDEX_BUFFER_FULLSCREEN });
    gl.useProgram(displacementAfterTInFrequencyProgram.program);
    gl.uniform1i(displacementAfterTInFrequencyProgram.uniformLocations['u_height_k'], UNIT_TEXTURE_HEIGHT_AFTER_T_IN_FREQUENCY);
    gl.uniform1f(displacementAfterTInFrequencyProgram.uniformLocations['u_transformSize'], TRANSFORM_SIZE);

    var fft1RowsProgram = buildProgramData(gl, passPositionVertexShader, fft1RowsFragmentShader, 
        { 'a_position': INDEX_BUFFER_FULLSCREEN });
    gl.useProgram(fft1RowsProgram.program);
    gl.uniform1f(fft1RowsProgram.uniformLocations['u_transformSize'], TRANSFORM_SIZE);

    var fft1ColsProgram = buildProgramData(gl, passPositionVertexShader, fft1ColsFragmentShader, 
        { 'a_position': INDEX_BUFFER_FULLSCREEN });
    gl.useProgram(fft1ColsProgram.program);
    gl.uniform1f(fft1ColsProgram.uniformLocations['u_transformSize'], TRANSFORM_SIZE);

    var fft2RowsProgram = buildProgramData(gl, passPositionVertexShader, fft2RowsFragmentShader, 
        { 'a_position': INDEX_BUFFER_FULLSCREEN });
    gl.useProgram(fft2RowsProgram.program);
    gl.uniform1f(fft2RowsProgram.uniformLocations['u_transformSize'], TRANSFORM_SIZE);

    var fft2ColsProgram = buildProgramData(gl, passPositionVertexShader, fft2ColsFragmentShader, 
        { 'a_position': INDEX_BUFFER_FULLSCREEN });
    gl.useProgram(fft2ColsProgram.program);
    gl.uniform1f(fft2ColsProgram.uniformLocations['u_transformSize'], TRANSFORM_SIZE);

    var gridProgram = buildProgramData(gl, gridVertexShader, gridFragmentShader, 
        { 'a_position': INDEX_BUFFER_GRID });
        // { 'a_position': INDEX_BUFFER_FULLSCREEN });
    gl.useProgram(gridProgram.program);
    gl.uniform1i(gridProgram.uniformLocations['u_height'], UNIT_TEXTURE_HEIGHT_AFTER_T_IN_TIME);
    gl.uniform1i(gridProgram.uniformLocations['u_displacement'], UNIT_TEXTURE_DISPLACEMENT_AFTER_T_IN_TIME);

    /*****************************************************************/
    /*******************INIT INPUT VERTEX BUFFER**********************/
    /*****************************************************************/
    var fullscreenVertexBufferData = [-1.0, -1.0, 1.0, -1.0, -1.0, 1.0, 1.0, 1.0];
    var fullscreenVertexNumber = 4;
    
    var gridBufferData = [];
    var gridVertexNumber = 3 * (TRANSFORM_SIZE - 1) * (TRANSFORM_SIZE - 1) * 2;

    for(var z = 0; z < TRANSFORM_SIZE - 1; z++){
        var t =  z      / TRANSFORM_SIZE * 2 - 1;
        var b = (z + 1) / TRANSFORM_SIZE * 2 - 1;
        for(var x = 0; x < TRANSFORM_SIZE - 1; x++){
            var l =  x      / TRANSFORM_SIZE * 2 - 1;
            var r = (x + 1) / TRANSFORM_SIZE * 2 - 1;
            gridBufferData.push(l);
            gridBufferData.push(t);
            gridBufferData.push(l);
            gridBufferData.push(b);
            gridBufferData.push(r);
            gridBufferData.push(b);

            gridBufferData.push(r);
            gridBufferData.push(b);
            gridBufferData.push(r);
            gridBufferData.push(t);
            gridBufferData.push(l);
            gridBufferData.push(t);
        }
    }



    gl.enableVertexAttribArray(INDEX_BUFFER_FULLSCREEN);
    gl.enableVertexAttribArray(INDEX_BUFFER_GRID);

    var fullscreenVertexBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, fullscreenVertexBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(fullscreenVertexBufferData), gl.STATIC_DRAW); 
    gl.vertexAttribPointer(INDEX_BUFFER_FULLSCREEN, 2, gl.FLOAT, false, 0, 0);

    var gridVertexBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, gridVertexBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(gridBufferData), gl.STATIC_DRAW); 
    gl.vertexAttribPointer(INDEX_BUFFER_GRID, 2, gl.FLOAT, false, 0, 0);

    


    gl.bindBuffer(gl.ARRAY_BUFFER, fullscreenVertexBuffer);






    /*****************************************************************/
    /*******************FFT MAIN LOOP FUNCTION************************/
    /*****************************************************************/
    var runFFT = function(fftRowsProgram, fftColsProgram, inputTextureUnit, outputFramebuffer){
        gl.useProgram(fftRowsProgram.program);
        gl.uniform1i(fftRowsProgram.uniformLocations['u_input'], inputTextureUnit);
        gl.uniform1f(fftRowsProgram.uniformLocations['u_subtransformSize'], 2);
        gl.bindFramebuffer(gl.FRAMEBUFFER, getCurrentPingPongFramebuffer());
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, fullscreenVertexNumber);

        var subtransformSize = 4;
        while(subtransformSize <= TRANSFORM_SIZE){
            gl.useProgram(fftRowsProgram.program);
            gl.uniform1i(fftRowsProgram.uniformLocations['u_input'], getCurrentPingPongTextureUnit());
            gl.uniform1f(fftRowsProgram.uniformLocations['u_subtransformSize'], subtransformSize);

            changeCurrentPingPong();
            gl.bindFramebuffer(gl.FRAMEBUFFER, getCurrentPingPongFramebuffer());
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, fullscreenVertexNumber);

            subtransformSize *= 2;
        }

        subtransformSize = 2;
        while(subtransformSize * 2 <= TRANSFORM_SIZE){
            gl.useProgram(fftColsProgram.program);
            gl.uniform1i(fftColsProgram.uniformLocations['u_input'], getCurrentPingPongTextureUnit());
            gl.uniform1f(fftColsProgram.uniformLocations['u_subtransformSize'], subtransformSize);

            changeCurrentPingPong();
            gl.bindFramebuffer(gl.FRAMEBUFFER, getCurrentPingPongFramebuffer());
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, fullscreenVertexNumber);

            subtransformSize *= 2;
        }

        gl.useProgram(fftColsProgram.program);
        gl.uniform1i(fftColsProgram.uniformLocations['u_input'], getCurrentPingPongTextureUnit());
        gl.uniform1f(fftColsProgram.uniformLocations['u_subtransformSize'], subtransformSize);
        gl.bindFramebuffer(gl.FRAMEBUFFER, outputFramebuffer);
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, fullscreenVertexNumber);
    }


    /*****************************************************************/
    /****************RENDER INIT HEIGHT IN FREQUENCY******************/
    /*****************************************************************/

    gl.useProgram(initHeightInFrequencyProgram.program);
    gl.bindFramebuffer(gl.FRAMEBUFFER, initHeightInFrequencyFramebuffer);
    gl.drawArrays(gl.TRIANGLE_STRIP, 0, fullscreenVertexNumber);



    var time = 0.0;

    var camera = new Camera();
    camera.changeAzimuth(100);
    console.log(camera);
    var viewMatrix = camera.getViewMatrix();
    

    // var viewMatrix = mat4.create();
    var projectonMatrix = mat4.create();
    // var distanceVec = vec3.create();
    // var scaleVec = vec3.create();


    mat4.perspective(projectonMatrix, (60 / 180) * Math.PI, window.innerWidth/window.innerHeight, 0, 10000);

    // vec3.set(distanceVec, 0, 0, -2.5);
    // vec3.set(scaleVec, 0.8, 0.8, 0.8);

    // mat4.scale(viewMatrix, viewMatrix, scaleVec);
    // mat4.translate(viewMatrix, viewMatrix, distanceVec);
    // mat4.rotateX(viewMatrix, viewMatrix, Math.PI/4);
    // mat4.rotateY(viewMatrix, viewMatrix, Math.PI/3);

    // console.log(viewMatrix);

    var nextFrame = function(){
        time += TIME_STEP;

        gl.useProgram(heightAfterTInFrequencyProgram.program);
        gl.uniform1f(heightAfterTInFrequencyProgram.uniformLocations['u_t'], time);
        gl.bindFramebuffer(gl.FRAMEBUFFER, heightAfterTInFrequencyFramebuffer);
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, fullscreenVertexNumber);

        gl.useProgram(displacementAfterTInFrequencyProgram.program);
        gl.bindFramebuffer(gl.FRAMEBUFFER, displacementAfterTInFrequencyFramebuffer);
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, fullscreenVertexNumber);

        runFFT(fft1RowsProgram, fft1ColsProgram, UNIT_TEXTURE_HEIGHT_AFTER_T_IN_FREQUENCY, heightAfterTInTimeFramebuffer);
        runFFT(fft2RowsProgram, fft2ColsProgram, UNIT_TEXTURE_DISPLACEMENT_AFTER_T_IN_FREQUENCY, displacementAfterTInTimeFramebuffer);

        gl.useProgram(gridProgram.program);
        gl.uniformMatrix4fv(gridProgram.uniformLocations['u_viewMatrix'], false, viewMatrix);
        gl.uniformMatrix4fv(gridProgram.uniformLocations['u_perspectiveMatrix'], false, projectonMatrix);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
        gl.drawArrays(gl.TRIANGLES, 0, gridVertexNumber);

        requestAnimationFrame(nextFrame);
    }

    requestAnimationFrame(nextFrame);

</script>